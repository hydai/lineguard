# LineLint 測試覆蓋率改善需求文件

## 1. 專案背景

LineLint 是一個 Rust 開發的命令列工具，用於驗證文字檔案的行尾格式和尾隨空白。目前專案的測試覆蓋率為 56%，距離 100% 的目標有顯著差距。

### 現況分析
- **整體覆蓋率**: 56% (425/571 行)
- **問題模組**:
  - checker/mod.rs: 68.82% (核心檢查邏輯)
  - reporter/mod.rs: 67.65% (輸出報告)
- **測試現況**: 主要依賴整合測試，缺乏單元測試

## 2. 需求目標

### 主要目標
將 LineLint 專案的測試覆蓋率從 56% 提升至 100%，優先處理核心功能模組。

### 具體目標
1. 為覆蓋率低於 70% 的核心模組增加單元測試
2. 改善程式碼結構以提高可測試性
3. 建立完善的測試基礎設施
4. 分離單元測試與整合測試

## 3. 限制與約束

### 技術限制
- 需遵循 TDD 開發流程
- 保持 API 向後相容
- 遵循 Rust 測試最佳實踐

### 範圍限制
- 不測試 panic 和不可達程式碼路徑
- 暫時忽略第三方函式庫的錯誤情況
- 已達 70%+ 覆蓋率的模組暫不處理

## 4. User Stories

### Story 1: 為 checker 模組增加單元測試
**描述**: 為核心檢查邏輯模組增加完整的單元測試覆蓋

**驗收標準**:
- [ ] checker/mod.rs 包含 #[cfg(test)] 模組
- [ ] 所有公開函數都有對應的單元測試
- [ ] 錯誤處理路徑都有測試覆蓋
- [ ] 邊界條件都有測試
- [ ] 模組覆蓋率達到 90% 以上
- [ ] 單元測試執行時間少於 1 秒

**優先級**: P0 (最高)

### Story 2: 為 reporter 模組增加單元測試
**描述**: 為輸出報告模組增加各種格式的單元測試

**驗收標準**:
- [ ] reporter/mod.rs 包含 #[cfg(test)] 模組
- [ ] 每種輸出格式都有測試
- [ ] 錯誤報告情境都有測試覆蓋
- [ ] 進度條顯示邏輯有測試
- [ ] 模組覆蓋率達到 90% 以上
- [ ] 測試不產生實際終端輸出

**優先級**: P0 (最高)

### Story 3: 重構程式碼以提高可測試性
**描述**: 重構難以測試的程式碼，改善架構設計

**驗收標準**:
- [ ] 識別並重構至少 3 個難以測試的函數
- [ ] 將 I/O 操作與業務邏輯分離
- [ ] 引入依賴注入模式
- [ ] 現有測試仍全部通過
- [ ] API 保持向後相容

**優先級**: P1 (高)

### Story 4: 建立測試輔助工具和 Mock
**描述**: 建立測試基礎設施，包含 mock 和測試輔助工具

**驗收標準**:
- [ ] 建立 FileSystem trait 和 mock 實作
- [ ] 建立 TestFixture 輔助建立測試資料
- [ ] 提供測試用的假資料生成器
- [ ] Mock 工具有清晰的文件說明
- [ ] 至少 3 個測試案例使用新工具

**優先級**: P1 (高)

### Story 5: 分離單元測試和整合測試
**描述**: 重新組織測試結構，清楚區分不同類型的測試

**驗收標準**:
- [ ] 所有單元測試移至 #[cfg(test)] 模組
- [ ] 整合測試保留在 tests/ 目錄
- [ ] 建立測試分類標籤
- [ ] cargo test --lib 在 5 秒內完成
- [ ] CI 配置支援分階段測試

**優先級**: P2 (中)

## 5. 實施計畫

### 第一階段：核心模組單元測試 (Week 1)
1. 為 checker 模組增加單元測試
2. 為 reporter 模組增加單元測試

### 第二階段：測試基礎設施 (Week 2)
1. 建立 mock 和測試輔助工具
2. 重構程式碼以提高可測試性

### 第三階段：測試組織優化 (Week 3)
1. 分離單元測試和整合測試
2. 優化 CI/CD 流程

## 6. 成功指標

### 量化指標
- 整體測試覆蓋率達到 100%
- checker 模組覆蓋率 ≥ 90%
- reporter 模組覆蓋率 ≥ 90%
- 單元測試執行時間 < 5 秒

### 質化指標
- 測試程式碼具有良好可讀性
- 測試覆蓋所有關鍵錯誤路徑
- 建立可重用的測試基礎設施
- 測試組織結構清晰

## 7. 風險評估

### 技術風險
- **風險**: 重構可能引入新的 bug
- **緩解**: 保持小步重構，每步都確保測試通過

### 時程風險
- **風險**: 達到 100% 覆蓋率可能需要大量時間
- **緩解**: 優先處理核心模組，分階段實施

## 8. 相關人員

- **需求方**: LineLint 專案維護者
- **實施方**: 開發團隊
- **驗收方**: 專案技術負責人

## 9. 附錄

### 目前覆蓋率詳情
```
checker/mod.rs: 68.82% (64/93 行)
reporter/mod.rs: 67.65% (46/68 行)
discovery/mod.rs: 70.15% (94/134 行)
config/mod.rs: 78.57% (22/28 行)
git/mod.rs: 78.57% (22/28 行)
main.rs: 79.39% (104/131 行)
fixer/mod.rs: 81.61% (71/87 行)
cli/mod.rs: 100% (2/2 行)
```

### 參考資料
- [Rust 測試最佳實踐](https://doc.rust-lang.org/book/ch11-00-testing.html)
- [cargo-tarpaulin 文件](https://github.com/xd009642/tarpaulin)
- 專案 CLAUDE.md 開發指南
